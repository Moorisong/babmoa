# Region-based Parking Information Display (v1.2)

## 1. 목적

- 서비스(투표 생성, 참여, 결과 조회)는 **전국 단위로 제공**한다.
- 주차 정보는 **실제 방문 기반 데이터의 신뢰도**를 최우선 기준으로 한다.
- 광고 트래픽 확보와 데이터 상품성을 분리하여 운영한다.
- 주차 데이터의 무분별한 확장을 방지하고 운영 통제권을 유지한다.

---

## 2. 기본 원칙

1. **전국 사용 가능**
   - 지역과 무관하게 모든 기능 사용 가능
   - 서비스 이용 제한으로 인식되는 UX는 지양한다.

2. **주차 데이터는 선별 노출**
   - 데이터 수집과 데이터 노출은 명확히 분리한다.
   - 주차 정보 노출 여부는 데이터 신뢰도 + 운영자 판단에 따른다.

---

## 3. 지역 상태 정의

서버 기준으로 지역은 다음 상태 중 하나를 가진다. 클라이언트는 지역 상태를 직접 알 필요가 없으며, 모든 판별 로직은 서버에서 처리한다.

| 상태 | 설명 |
|---|---|
| `OPEN_REGION` | 기본 상태 (전국) |
| `CANDIDATE_REGION` | 승격 검토 대상 지역 |
| `CORE_REGION` | 주차 정보 노출 지역 |

---

## 4. 지역 판별 기준

- **행정구역 기준**: 장소 단위가 아닌 행정구역(시/군/구) 단위로 관리한다.
- **판별 방식**: 장소의 행정구역 정보를 서버에서 판별한다. (지도 API 제공 좌표 → 행정구역 변환 로직 사용)

---

## 5. 주차 데이터 처리 정책

### 5.1 ParkingData (원본 데이터)

| 항목 | OPEN_REGION | CANDIDATE_REGION | CORE_REGION |
|---|---|---|---|
| 주차 경험 기록 | **허용** | **허용** | **허용** |
| 데이터 저장 | 저장 | 저장 | 저장 |
| TTL | 1년 | 1년 | 1년 |

> **핵심**: 모든 지역에서 주차 경험 기록은 동일하게 허용하며, 데이터 수집은 항상 열린 구조를 유지한다.

### 5.2 ParkingStats (집계 데이터)

| 항목 | OPEN_REGION | CANDIDATE_REGION | CORE_REGION |
|---|---|---|---|
| 통계 집계 | ❌ | ⭕ | ⭕ |
| 성공률 계산 | ❌ | 내부 참고용 | ⭕ |
| UI 노출 | ❌ | ❌ | ⭕ |
| B2B 활용 | ❌ | ❌ | ⭕ |

> **핵심**: `CANDIDATE_REGION`의 통계는 운영자 검토용 내부 지표로만 사용한다.

---

## 6. 주차 정보 UI 노출 정책

### 6.1 주차 뱃지 표시 규칙

| 항목 | OPEN_REGION | CANDIDATE_REGION | CORE_REGION |
|---|---|---|---|
| 주차 뱃지 표시 | ❌ | ❌ | ⭕ |
| 성공률 수치 | ❌ | ❌ | ⭕ |
| 상태 문구 | ☁️ 데이터 수집 중 | ☁️ 데이터 검토 중 | 색상 뱃지 |

### 6.2 공통 안내 문구 (필수)

주차 정보가 노출되는 모든 영역에는 아래 문구를 포함한다.

> "주차 정보는 실제 방문 기록을 기반으로 제공되며, 지역 및 장소에 따라 표시되지 않을 수 있습니다."

- 지역명을 직접적으로 언급하지 않는다.
- 기능 제한이 아닌 데이터 신뢰도 기준임을 명확히 전달한다.

---

## 7. 지역 승격 정책 (자동 ⭕ / 수동 ⭕)

본 서비스는 **운영 효율성**과 **예측 가능성**을 위해, **AI 판단을 사용하지 않는 정량 조건 기반 자동 승격 정책**을 적용한다.

### 7.1 AUTO_CORE_REGION 자동 승격 (조건 기반)

아래 조건을 **모두 만족**할 경우, 별도의 운영자 승인 없이 `CORE_REGION`으로 자동 승격된다.

| 조건 항목 | 기준값 |
|---|---|
| ParkingData 누적 | **120건 이상** |
| 참여자 (participantId) | **40명 이상** |
| TimeSlot 분포 | **3개 이상** |
| 데이터 수집 기간 | **30일 이상** |

> **제한 사항**:
> - 모든 조건은 행정구역(시/군/구) 단위로 1일 1회 백그라운드 집계한다.
> - **AI 추론, 모델 가중치, 외부 신호(트래픽 등)는 절대 사용하지 않는다.**
> - 하나라도 조건을 미충족하면 승격되지 않는다.

### 7.2 수동 승격 (운영자 개입)

자동 승격 기준에는 미달하나, 전략적으로 필요한 경우 운영자가 수동으로 승격할 수 있다.

1. 서버에서 기준 지표(7.1보다는 낮은 임계값) 충족 여부 집계 (기존 CANDIDATE 기준 유지)
2. `CANDIDATE_REGION` 상태로 분류
3. 운영자 대시보드에 노출 및 수동 승인

### 7.3 승격 후 UX 변화

자동 또는 수동으로 `CORE_REGION`이 되면 즉시 다음 데이터가 활성화된다.
- **주차 뱃지** (색상/아이콘)
- **성공률 수치** (%)
- **상태 문구** (수집중/검토중 → 실제 데이터)
- **주차 통계 정보 API**

*승격 이전에 수집된 데이터도 통계 계산에 모두 포함된다.*

---

## 8. Metrics Aggregation Policy (집계 작업 명세)

본 정책은 지역 상태 판단을 위한 **지표 집계 방식**을 정의한다.
집계 작업은 서비스 기능과 분리된 **백그라운드 처리**로 수행되며, 실시간 계산이나 사용자 요청에 의해 트리거되어서는 안 된다.

### 8.1 집계 수행 방식
- **백그라운드 배치**: 지역 지표 집계는 1일 1회 배치 작업으로만 수행한다.
- **트리거 제한**: API 요청, 페이지 진입 등 사용자 액션에 의해 집계가 실행되어서는 안 된다.

### 8.2 집계 주기 및 대상
- **주기**: 1일 1회 (트래픽 적은 시간대)
- **대상**: `ParkingData` (정상 기록된 데이터만 포함, 삭제/테스트 데이터 제외)
- **단위**: 행정구역(시/군/구)

### 8.3 집계 산출 항목
- `totalParkingRecords`: 주차 경험 총 기록 수
- `uniqueParticipants`: 서로 다른 participantId 수
- `timeSlotDistribution`: 시간대 분포 개수
- `firstRecordedAt`, `lastRecordedAt`: 데이터 수집 시점

> **제한**: 집계 결과는 내부 정책 판단용이며, 사용자 UI에 직접 노출되지 않는다.

---

## 9. API Safety Rule (필수)

지역 상태에 따른 API 응답 안전성을 보장하기 위한 필수 가드이다.

### 9.1 API 응답 제한 원칙
`OPEN_REGION`, `CANDIDATE_REGION`에 대해 다음 정보는 **API 응답 자체에서 제거(null)**해야 한다.
- 주차 성공률
- 주차 통계 수치
- 주차 뱃지 상태
- 주차 관련 요약 데이터

> 클라이언트의 숨김 처리에 의존하지 않고, 서버에서 원천 차단한다.

### 9.2 CORE_REGION 응답 허용 범위
오직 `CORE_REGION`일 경우에만 뱃지, 성공률, 통계 요약 데이터를 제공한다.

---

## 10. Fixed Copy Rule (문구 고정 정책)

### 10.1 고정 문구
아래 문구는 의미 변경 없이 그대로 사용해야 한다. (A/B 테스트, AI 변형 금지)

> "주차 정보는 실제 방문 기록을 기반으로 제공되며, 지역 및 장소에 따라 표시되지 않을 수 있습니다."

### 10.2 문구 사용 제한
- 특정 지역명, 도시명 언급 금지
- "서비스 미지원", "기능 제한" 등 부정적 표현 금지

---

## 11. Design Principle (데이터 수집 ≠ 정보 노출)

- **독립성**: 데이터 수집 가능 여부와 정보 노출 여부는 서로 독립적이다.
- **유효성**: 정보가 노출되지 않는 지역이라도 수집된 데이터는 유효하게 저장된다. (미노출 ≠ 데이터 품질 부족)

---

## 12. External Data Usage Policy (외부 제공 제한)

- **사용 금지**: `OPEN_REGION`, `CANDIDATE_REGION` 데이터는 외부 리포트, 광고, B2B 제공 등에 사용할 수 없다.
- **사용 허용**: 오직 `CORE_REGION` 데이터만 외부 제공 및 분석 대상이 된다.

---

## 13. CORE_REGION Filter & Map UX Specification

이 섹션은 주차 정보 지도/리스트의 필터 및 UX 정책을 정의한다.

### 13.1 Initial Map Load (초기 진입)
- **위치 기준**:
  - 기본: 유저 브라우저 위치(Geolocation)를 최우선으로 한다. (대구/경산 중심 고정 아님)
  - 위치 확인 불가 시: 기획된 기본 범위 또는 전체 지도를 표시한다.
- **마커 표시**:
  - 모든 장소의 마커를 표시할 수 있다.
  - 단, 뱃지와 통계 정보는 `CORE_REGION`이며 조건이 충족된 경우에만 마커 위에 표시한다.

### 13.2 Filter UI Changes
- **필터 제거**:
  - 기존의 지역 한정 필터 버튼 및 `CORE_REGION` 전용 필터 버튼을 **모두 제거**한다.
  - 사용자가 별도로 필터를 켜고 끌 필요 없이, 지도 이동 및 검색 결과에 따라 자연스럽게 정보가 노출되도록 한다.
- **기본 상태**:
  - 마커는 전국 모든 지역에 표시된다.
  - 주차 뱃지(P)는 `CORE_REGION` 데이터가 있는 경우에만 마커 위에 자동으로 표시된다.

### 13.3 Behavior When No CORE_REGION Data
- `CORE_REGION` 데이터가 없는 지역을 보고 있거나 클릭했을 경우:
    1. **마커 표시**: 마커는 정상적으로 표시된다.
    2. **상세 정보**: 주차 정보 대신 고정 안내 문구를 표시한다.
    3. **안내 문구**:
       > "주차 정보는 실제 방문 기록을 기반으로 제공되며, 지역 및 장소에 따라 표시되지 않을 수 있습니다."

### 13.4 Client-Side Optimization (Hybrid Check)
- **목적**: API 응답 대기 없이 즉각적인 UI 반응을 제공하기 위함.
- **방식**: 클라이언트에서 장소의 주소 텍스트를 분석하여 `CORE_REGION` 키워드(예: 대구, 경산) 포함 여부를 1차 판별한다.
- **활용**: 검색 결과 리스트, 바텀시트 등에서 주차 정보 표시 여부를 결정할 때 사용한다.


### 13.5 Map Marker & Badge Display
- **OPEN / CANDIDATE**: 마커만 표시 (뱃지/통계 숨김). 클릭 시 주차 정보 기록은 가능.
- **CORE**: 마커 + 주차 뱃지(색상) + 성공률(%) 표시.

### 13.6 Future / Expansion
- UI 구조는 향후 `CORE_REGION`이 전국으로 확장되어도 수정 없이 동작해야 한다.
- MVP 단계에서는 빈 지도 안내 처리와 고정 문구 적용을 최우선으로 한다.

### 13.7 Notes for Developers
- 필터 상태(UI)와 API 데이터 응답(Data)은 독립적으로 관리해야 한다. (API에서 정보가 안 와도 필터는 동작 가능)
- 클라이언트는 API 응답이 없을 때 적절한 Empty UX를 보여주어야 한다.

---

## 14. UX 흐름 영향

- 투표 생성 / 참여 / 결과 / 주차 기록 UX 플로우는 변경하지 않는다.
- 지역 상태에 따른 UX 차별은 **주차 정보 영역**에만 한정한다.
- `OPEN_REGION`에서도 주차 경험 기록은 항상 가능하다.

---

## 15. 유의사항

- “대구·경산만 제공”과 같은 직접적인 지역 제한 문구는 사용하지 않는다.
- 주차 정보 미노출은 서비스 제한이 아닌 **데이터 조건 문제**로 인식되어야 한다.
- 운영자 승인 로직은 반드시 서버 권한으로만 처리한다.

---

## 16. 요약

본 서비스는 전국에서 사용 가능하나, 주차 정보는 **실제 방문 기록 기반의 데이터 신뢰도**와 **운영자 승인**에 따라 일부 지역 및 장소에서만 제공된다.

